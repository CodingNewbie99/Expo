# Migrating [Universal Modules][universal-modules] to TypeScript

## Change default import to named import

To optimize our libraries for _dead code elimination_ we should migrate our exports to be imported as such:

```diff

- import { FileSystem } from 'expo-file-system';

+ import * as FileSystem from 'expo-file-system';

```

Ideally we would make the main entry-point of a module be a file named like the module:
`src/FileSystem.ts` (`build/FileSystem.js`).
To migrate from libraries using different imports, we should add a deprecation notice:

**`src/index.ts`**

```ts
import * as FileSystem from './FileSystem';
export * from './FileSystem';

let wasImportWarningShown = false;
// @ts-ignore: Temporarily define an export named "FileSystem" for legacy compatibility
Object.defineProperty(exports, 'FileSystem', {
  get() {
    if (!wasImportWarningShown) {
      console.warn(
        `The syntax "import { FileSystem } from 'expo-file-system'" is deprecated. Use "import * as FileSystem from 'expo-file-system'" or import named exports instead. Support for the old syntax will be removed in SDK 34.`
      );
      wasImportWarningShown = true;
    }
    return FileSystem;
  },
});
```

Then eventually remove the index in favor of the named file. (`src/FileSystem.ts`)

## Added tests

Migration should include the addition of a `src/__tests__` which can be run with `yarn test` in the root directory of the package.

If the package is using the old structure of `test/` for utilities, they should migrate to using `jest-expo`.

```diff
- import { mockPlatformWeb } from '../../test/mocking';

+ import { mockPlatformWeb } from 'jest-expo';
```

## Moved native dependencies to `peerDependencies`

In order to prevent overlapping native code in `node_modules`, we should move any `dependencies` containing native code to `peerDependencies`.

## Add module scripts

```js
"scripts": {
    "build": "expo-module build",
    "clean": "expo-module clean",
    "test": "expo-module test",
    "prepare": "expo-module prepare",
    "prepublishOnly": "expo-module prepublishOnly",
    "expo-module": "expo-module"
}
```

## Generate a `tsconfig.json` with `expo-module-scripts`

To get the `tsconfig` that we use in all of our modules, run `expo-module prepare` or the yarn script `yarn prepare` (given the script is defined in a module's `package.json`)

`/tsconfig.json`

```json
// @generated by expo-module-scripts
{
  "extends": "expo-module-scripts/tsconfig.base",
  "compilerOptions": {
    "outDir": "./build"
  },
  "include": ["./src"],
  "exclude": ["**/__mocks__/*", "**/__tests__/*"]
}
```

## Various Changes

- Remove `babel-preset-expo`
- Remove `flow`
- For reusing types across the web implementation's native layer and API layer, types should be moved to a named file with the `.types.ts` extension. There are cases (`expo-av` for example) where you should separate types into smaller files.

[universal-modules]: https://github.com/expo/expo/blob/master/guides/Expo%20Universal%20Module%20Infrastructure.md
