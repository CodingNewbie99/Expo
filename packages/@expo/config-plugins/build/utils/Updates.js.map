{"version":3,"file":"Updates.js","names":["_sdkRuntimeVersions","data","require","_fs","_interopRequireDefault","_getenv","_path","_resolveFrom","_semver","_Version","_Version2","_Version3","obj","__esModule","default","FINGERPRINT_RUNTIME_VERSION_SENTINEL","exports","getExpoUpdatesPackageVersion","projectRoot","expoUpdatesPackageJsonPath","resolveFrom","silent","fs","existsSync","packageJson","JSON","parse","readFileSync","version","getUpdateUrl","config","updates","url","getAppVersion","getNativeVersion","platform","buildNumber","getBuildNumberIos","getBuildNumberMacos","versionCode","getVersionCode","Error","getRuntimeVersionNullableAsync","getRuntimeVersionAsync","e","boolish","console","log","runtimeVersion","policy","resolveRuntimeVersionPolicyAsync","sdkVersion","getRuntimeVersionForSDKVersion","getSDKVersion","getUpdatesEnabled","enabled","undefined","getUpdatesTimeout","fallbackToCacheTimeout","getUpdatesCheckOnLaunch","expoUpdatesPackageVersion","checkAutomatically","semver","gte","getUpdatesCodeSigningCertificate","codeSigningCertificatePath","codeSigningCertificate","finalPath","path","join","getUpdatesCodeSigningMetadata","codeSigningMetadata","getUpdatesCodeSigningMetadataStringified","metadata","stringify","getUpdatesRequestHeaders","requestHeaders","getUpdatesRequestHeadersStringified"],"sources":["../../src/utils/Updates.ts"],"sourcesContent":["import { Android, ExpoConfig, IOS, MacOS } from '@expo/config-types';\nimport { getRuntimeVersionForSDKVersion } from '@expo/sdk-runtime-versions';\nimport fs from 'fs';\nimport { boolish } from 'getenv';\nimport path from 'path';\nimport resolveFrom from 'resolve-from';\nimport semver from 'semver';\n\nimport { getVersionCode } from '../android/Version';\nimport { getBuildNumber as getBuildNumberIos } from '../ios/Version';\nimport { getBuildNumber as getBuildNumberMacos } from '../macos/Version';\n\nexport type ExpoConfigUpdates = Pick<\n  ExpoConfig,\n  'sdkVersion' | 'owner' | 'runtimeVersion' | 'updates' | 'slug'\n>;\n\nexport const FINGERPRINT_RUNTIME_VERSION_SENTINEL = 'file:fingerprint';\n\nexport function getExpoUpdatesPackageVersion(projectRoot: string): string | null {\n  const expoUpdatesPackageJsonPath = resolveFrom.silent(projectRoot, 'expo-updates/package.json');\n  if (!expoUpdatesPackageJsonPath || !fs.existsSync(expoUpdatesPackageJsonPath)) {\n    return null;\n  }\n  const packageJson = JSON.parse(fs.readFileSync(expoUpdatesPackageJsonPath, 'utf8'));\n  return packageJson.version;\n}\n\nexport function getUpdateUrl(config: Pick<ExpoConfigUpdates, 'updates'>): string | null {\n  return config.updates?.url ?? null;\n}\n\nexport function getAppVersion(config: Pick<ExpoConfig, 'version'>): string {\n  return config.version ?? '1.0.0';\n}\n\nexport function getNativeVersion(\n  config: Pick<ExpoConfig, 'version'> & {\n    android?: Pick<Android, 'versionCode'>;\n    ios?: Pick<IOS, 'buildNumber'>;\n    macos?: Pick<MacOS, 'buildNumber'>;\n  },\n  platform: 'android' | 'ios' | 'macos'\n): string {\n  // For review: We used to use the iOS getVersion() method for all platforms\n  // here, which is subtly different to getAppVersion() above as it uses ||\n  // rather than ??. I've inlined it to prevent regression.\n  const version = config.version || '1.0.0';\n  switch (platform) {\n    case 'ios': {\n      const buildNumber = getBuildNumberIos(config);\n      return `${version}(${buildNumber})`;\n    }\n    case 'macos': {\n      const buildNumber = getBuildNumberMacos(config);\n      return `${version}(${buildNumber})`;\n    }\n    case 'android': {\n      const versionCode = getVersionCode(config);\n      return `${version}(${versionCode})`;\n    }\n    default: {\n      throw new Error(\n        `\"${platform}\" is not a supported platform. Choose either \"ios\", \"macos\", or \"android\".`\n      );\n    }\n  }\n}\n\nexport async function getRuntimeVersionNullableAsync(\n  ...[projectRoot, config, platform]: Parameters<typeof getRuntimeVersionAsync>\n): Promise<string | null> {\n  try {\n    return await getRuntimeVersionAsync(projectRoot, config, platform);\n  } catch (e) {\n    if (boolish('EXPO_DEBUG', false)) {\n      console.log(e);\n    }\n    return null;\n  }\n}\n\nexport async function getRuntimeVersionAsync(\n  projectRoot: string,\n  config: Pick<ExpoConfig, 'version' | 'runtimeVersion' | 'sdkVersion'> & {\n    android?: Pick<Android, 'versionCode' | 'runtimeVersion'>;\n    ios?: Pick<IOS, 'buildNumber' | 'runtimeVersion'>;\n    macos?: Pick<MacOS, 'buildNumber' | 'runtimeVersion'>;\n  },\n  platform: 'android' | 'ios' | 'macos'\n): Promise<string | null> {\n  const runtimeVersion = config[platform]?.runtimeVersion ?? config.runtimeVersion;\n  if (!runtimeVersion) {\n    return null;\n  }\n\n  if (typeof runtimeVersion === 'string') {\n    if (runtimeVersion === FINGERPRINT_RUNTIME_VERSION_SENTINEL) {\n      throw new Error(\n        `${FINGERPRINT_RUNTIME_VERSION_SENTINEL} is a reserved value for runtime version. To use a fingerprint runtime version, use the \"fingerprint\" runtime version policy.`\n      );\n    }\n    return runtimeVersion;\n  } else if (!runtimeVersion.policy) {\n    throw new Error(\n      `\"${runtimeVersion}\" is not a valid runtime version. Only a string or a runtime version policy is supported.`\n    );\n  } else if (runtimeVersion.policy === 'fingerprint') {\n    return FINGERPRINT_RUNTIME_VERSION_SENTINEL;\n  } else {\n    return await resolveRuntimeVersionPolicyAsync(runtimeVersion.policy, config, platform);\n  }\n}\n\nexport async function resolveRuntimeVersionPolicyAsync(\n  policy: 'appVersion' | 'nativeVersion' | 'sdkVersion',\n  config: Pick<ExpoConfig, 'version' | 'sdkVersion'> & {\n    android?: Pick<Android, 'versionCode'>;\n    ios?: Pick<IOS, 'buildNumber'>;\n    macos?: Pick<MacOS, 'buildNumber'>;\n  },\n  platform: 'android' | 'ios' | 'macos'\n): Promise<string> {\n  if (policy === 'appVersion') {\n    return getAppVersion(config);\n  } else if (policy === 'nativeVersion') {\n    return getNativeVersion(config, platform);\n  } else if (policy === 'sdkVersion') {\n    if (!config.sdkVersion) {\n      throw new Error(\"An SDK version must be defined when using the 'sdkVersion' runtime policy.\");\n    }\n    return getRuntimeVersionForSDKVersion(config.sdkVersion);\n  } else {\n    // fingerprint is resolvable only at build time (not in config plugin).\n    throw new Error(`\"${policy}\" is not a valid runtime version policy type.`);\n  }\n}\n\nexport function getSDKVersion(config: Pick<ExpoConfigUpdates, 'sdkVersion'>): string | null {\n  return typeof config.sdkVersion === 'string' ? config.sdkVersion : null;\n}\n\nexport function getUpdatesEnabled(config: Pick<ExpoConfigUpdates, 'updates'>): boolean {\n  // allow override of enabled property\n  if (config.updates?.enabled !== undefined) {\n    return config.updates.enabled;\n  }\n\n  return getUpdateUrl(config) !== null;\n}\n\nexport function getUpdatesTimeout(config: Pick<ExpoConfigUpdates, 'updates'>): number {\n  return config.updates?.fallbackToCacheTimeout ?? 0;\n}\n\nexport function getUpdatesCheckOnLaunch(\n  config: Pick<ExpoConfigUpdates, 'updates'>,\n  expoUpdatesPackageVersion?: string | null\n): 'NEVER' | 'ERROR_RECOVERY_ONLY' | 'ALWAYS' | 'WIFI_ONLY' {\n  if (config.updates?.checkAutomatically === 'ON_ERROR_RECOVERY') {\n    // native 'ERROR_RECOVERY_ONLY' option was only introduced in 0.11.x\n    if (expoUpdatesPackageVersion && semver.gte(expoUpdatesPackageVersion, '0.11.0')) {\n      return 'ERROR_RECOVERY_ONLY';\n    }\n    return 'NEVER';\n  } else if (config.updates?.checkAutomatically === 'ON_LOAD') {\n    return 'ALWAYS';\n  } else if (config.updates?.checkAutomatically === 'WIFI_ONLY') {\n    return 'WIFI_ONLY';\n  } else if (config.updates?.checkAutomatically === 'NEVER') {\n    return 'NEVER';\n  }\n  return 'ALWAYS';\n}\n\nexport function getUpdatesCodeSigningCertificate(\n  projectRoot: string,\n  config: Pick<ExpoConfigUpdates, 'updates'>\n): string | undefined {\n  const codeSigningCertificatePath = config.updates?.codeSigningCertificate;\n  if (!codeSigningCertificatePath) {\n    return undefined;\n  }\n\n  const finalPath = path.join(projectRoot, codeSigningCertificatePath);\n  if (!fs.existsSync(finalPath)) {\n    throw new Error(`File not found at \\`updates.codeSigningCertificate\\` path: ${finalPath}`);\n  }\n\n  return fs.readFileSync(finalPath, 'utf8');\n}\n\nexport function getUpdatesCodeSigningMetadata(\n  config: Pick<ExpoConfigUpdates, 'updates'>\n): NonNullable<ExpoConfigUpdates['updates']>['codeSigningMetadata'] {\n  return config.updates?.codeSigningMetadata;\n}\n\nexport function getUpdatesCodeSigningMetadataStringified(\n  config: Pick<ExpoConfigUpdates, 'updates'>\n): string | undefined {\n  const metadata = getUpdatesCodeSigningMetadata(config);\n  if (!metadata) {\n    return undefined;\n  }\n\n  return JSON.stringify(metadata);\n}\n\nexport function getUpdatesRequestHeaders(\n  config: Pick<ExpoConfigUpdates, 'updates'>\n): NonNullable<ExpoConfigUpdates['updates']>['requestHeaders'] {\n  return config.updates?.requestHeaders;\n}\n\nexport function getUpdatesRequestHeadersStringified(\n  config: Pick<ExpoConfigUpdates, 'updates'>\n): string | undefined {\n  const metadata = getUpdatesRequestHeaders(config);\n  if (!metadata) {\n    return undefined;\n  }\n\n  return JSON.stringify(metadata);\n}\n"],"mappings":"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"}