{"version":3,"file":"withPatchPlugin.js","names":["_getenv","data","require","_glob","_path","_interopRequireDefault","_withMod","_withRunOnce","_gitPatch","_warnings","obj","__esModule","default","EXPO_DEBUG","boolish","withPatchMod","config","platform","withMod","mod","action","_config$_internal$tem","_config$_internal","props","createPropsFromConfig","projectRoot","modRequest","templateChecksum","_internal","patchFilePath","determinePatchFilePathAsync","changedLines","getPatchChangedLinesAsync","changedLinesLimit","addWarningForPlatform","applyPatchAsync","createPatchPlugin","platformName","charAt","toUpperCase","slice","pluginName","withUnknown","withRunOnce","plugin","name","Object","defineProperty","value","patchRoot","path","join","patchFiles","getPatchFilesAsync","patchExists","includes","basename","length","firstPatchFilePath","console","log","Promise","resolve","reject","glob","cwd","error","matches","_config$plugins$find$","_config$plugins","_config$plugins$find","_patchPluginConfig$pa","_patchPluginConfig$ch","patchPluginConfig","plugins","find","Array","isArray"],"sources":["../../src/plugins/withPatchPlugin.ts"],"sourcesContent":["import type { ExpoConfig } from '@expo/config-types';\nimport { boolish } from 'getenv';\nimport { glob } from 'glob';\nimport path from 'path';\n\nimport { withMod } from './withMod';\nimport { withRunOnce } from './withRunOnce';\nimport type { ConfigPlugin, ModPlatform } from '../Plugin.types';\nimport { applyPatchAsync, getPatchChangedLinesAsync } from '../utils/gitPatch';\nimport { addWarningForPlatform } from '../utils/warnings';\n\nconst EXPO_DEBUG = boolish('EXPO_DEBUG', false);\n\ninterface PatchPluginProps {\n  /** The directory to search for patch files in. */\n  patchRoot: string;\n  /** The maximum changed lines allowed in the patch file, if exceeded the patch will show a warning. */\n  changedLinesLimit: number;\n}\n\nconst withPatchMod: ConfigPlugin<ModPlatform> = (config, platform) => {\n  return withMod(config, {\n    platform,\n    mod: 'patch',\n    action: async (config) => {\n      const props = createPropsFromConfig(config);\n      const projectRoot = config.modRequest.projectRoot;\n      const templateChecksum = config._internal?.templateChecksum ?? '';\n      const patchFilePath = await determinePatchFilePathAsync(\n        projectRoot,\n        platform,\n        templateChecksum,\n        props\n      );\n      if (patchFilePath != null) {\n        const changedLines = await getPatchChangedLinesAsync(patchFilePath);\n        if (changedLines > props.changedLinesLimit) {\n          addWarningForPlatform(\n            platform,\n            'withPatchPlugin',\n            `The patch file \"${patchFilePath}\" has ${changedLines} changed lines, which exceeds the limit of ${props.changedLinesLimit}.`\n          );\n        }\n\n        await applyPatchAsync(projectRoot, patchFilePath);\n      }\n      return config;\n    },\n  });\n};\n\nexport function createPatchPlugin(platform: ModPlatform): ConfigPlugin {\n  const platformName = platform.charAt(0).toUpperCase() + platform.slice(1);\n  const pluginName = `with${platformName}PatchPlugin`;\n  const withUnknown: ConfigPlugin = (config) => {\n    return withRunOnce(config, {\n      plugin: (config) => withPatchMod(config, platform),\n      name: pluginName,\n    });\n  };\n  Object.defineProperty(withUnknown, 'name', {\n    value: pluginName,\n  });\n  return withUnknown;\n}\n\nasync function determinePatchFilePathAsync(\n  projectRoot: string,\n  platform: ModPlatform,\n  templateChecksum: string,\n  props: PatchPluginProps\n): Promise<string | null> {\n  const patchRoot = path.join(projectRoot, props.patchRoot);\n  let patchFilePath = path.join(patchRoot, `${platform}+${templateChecksum}.patch`);\n\n  const patchFiles = await getPatchFilesAsync(patchRoot, platform, props);\n  let patchExists = patchFiles.includes(path.basename(patchFilePath));\n  if (patchFiles.length > 0 && !patchExists) {\n    const firstPatchFilePath = path.join(patchRoot, patchFiles[0]);\n    addWarningForPlatform(\n      platform,\n      'withPatchPlugin',\n      `Having patch files in ${patchRoot} but none matching \"${patchFilePath}\", using \"${firstPatchFilePath}\" instead.`\n    );\n    patchFilePath = firstPatchFilePath;\n    patchExists = true;\n  } else if (patchFiles.length > 1) {\n    addWarningForPlatform(\n      platform,\n      'withPatchPlugin',\n      `Having multiple patch files in ${patchRoot} is not supported. Only matched patch file \"${patchFilePath}\" will be applied.`\n    );\n  }\n\n  if (EXPO_DEBUG) {\n    console.log(\n      patchExists\n        ? `[withPatchPlugin] Applying patch from ${patchFilePath}`\n        : `[WithPatchPlugin] No patch found: ${patchFilePath}`\n    );\n  }\n  if (!patchExists) {\n    return null;\n  }\n  return patchFilePath;\n}\n\nasync function getPatchFilesAsync(\n  patchRoot: string,\n  platform: ModPlatform,\n  props: PatchPluginProps\n): Promise<string[]> {\n  return await new Promise<string[]>((resolve, reject) => {\n    glob(`${platform}*.patch`, { cwd: patchRoot }, (error, matches) => {\n      if (error) {\n        reject(error);\n      } else {\n        resolve(matches);\n      }\n    });\n  });\n}\n\nfunction createPropsFromConfig(config: ExpoConfig): PatchPluginProps {\n  const patchPluginConfig =\n    config.plugins?.find(\n      (plugin) => Array.isArray(plugin) && plugin[0] === 'withPatchPlugin'\n    )?.[1] ?? {};\n  return {\n    patchRoot: patchPluginConfig.patchRoot ?? 'cng-patches',\n    changedLinesLimit: patchPluginConfig.changedLinesLimit ?? 300,\n  };\n}\n"],"mappings":"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"}