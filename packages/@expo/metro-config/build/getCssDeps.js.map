{"version":3,"file":"getCssDeps.js","names":["_crypto","data","_interopRequireDefault","require","_js","_path","_css","obj","__esModule","default","getCssModules","dependencies","processModuleFilter","projectRoot","assets","module","values","isJsModule","getJsOutput","type","path","relative","cssMetadata","getCssMetadata","contents","code","filename","join","STATIC_EXPORT_DIRECTORY","fileNameFromContents","filepath","src","originFilename","push","source","metadata","hmrId","pathToHtmlSafeName","_module$output$","output","css","Error","JSON","stringify","getFileName","hashString","basename","replace","str","crypto","createHash","update","digest"],"sources":["../src/getCssDeps.ts"],"sourcesContent":["import crypto from 'crypto';\nimport type { Module } from 'metro';\nimport { getJsOutput, isJsModule } from 'metro/src/DeltaBundler/Serializers/helpers/js';\nimport path from 'path';\n\nimport { SerialAsset } from './serializerAssets';\nimport { pathToHtmlSafeName } from './transform-worker/css';\n\nexport type ReadOnlyDependencies<T = any> = Map<string, Module<T>>;\n\ntype Options = {\n  processModuleFilter: (modules: Module) => boolean;\n  assetPlugins: readonly string[];\n  platform?: string | null;\n  projectRoot: string;\n  publicPath: string;\n};\n\ntype MetroModuleCSSMetadata = {\n  code: string;\n  lineCount: number;\n  map: any[];\n};\n\nexport function getCssModules(\n  dependencies: ReadOnlyDependencies,\n  { processModuleFilter, projectRoot }: Pick<Options, 'projectRoot' | 'processModuleFilter'>\n): SerialAsset[] {\n  const assets: SerialAsset[] = [];\n\n  for (const module of dependencies.values()) {\n    if (\n      isJsModule(module) &&\n      processModuleFilter(module) &&\n      getJsOutput(module).type === 'js/module' &&\n      path.relative(projectRoot, module.path) !== 'package.json'\n    ) {\n      const cssMetadata = getCssMetadata(module);\n      if (cssMetadata) {\n        const contents = cssMetadata.code;\n        const filename = path.join(\n          // Consistent location\n          STATIC_EXPORT_DIRECTORY,\n          // Hashed file contents + name for caching\n          fileNameFromContents({\n            filepath: module.path,\n            src: contents,\n          }) + '.css'\n        );\n        const originFilename = path.relative(projectRoot, module.path);\n        assets.push({\n          type: 'css',\n          originFilename,\n          filename,\n          source: contents,\n          metadata: {\n            hmrId: pathToHtmlSafeName(originFilename),\n          },\n        });\n      }\n    }\n  }\n\n  return assets;\n}\n\nfunction getCssMetadata(module: Module): MetroModuleCSSMetadata | null {\n  const data = module.output[0]?.data;\n  if (data && typeof data === 'object' && 'css' in data) {\n    if (typeof data.css !== 'object' || !('code' in (data as any).css)) {\n      throw new Error(\n        `Unexpected CSS metadata in Metro module (${module.path}): ${JSON.stringify(data.css)}`\n      );\n    }\n    return data.css as MetroModuleCSSMetadata;\n  }\n  return null;\n}\n\n// s = static\nconst STATIC_EXPORT_DIRECTORY = '_expo/static/css';\n\nexport function fileNameFromContents({ filepath, src }: { filepath: string; src: string }): string {\n  return getFileName(filepath) + '-' + hashString(filepath + src);\n}\n\nexport function getFileName(module: string) {\n  return path.basename(module).replace(/\\.[^.]+$/, '');\n}\n\nexport function hashString(str: string) {\n  return crypto.createHash('md5').update(str).digest('hex');\n}\n"],"mappings":"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"}