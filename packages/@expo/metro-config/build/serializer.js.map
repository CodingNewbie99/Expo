{"version":3,"file":"serializer.js","names":["_baseJSBundle","data","_interopRequireDefault","require","_bundleToString","obj","__esModule","default","debug","replaceEnvironmentVariables","code","env","replace","match","_env$name","name","test","value","JSON","stringify","getTransformEnvironment","url","serializeWithEnvironmentVariables","entryPoint","preModules","graph","options","sourceUrl","dependencies","values","path","index","output","process","withExpoSerializers","config","withSerialProcessors","processors","_config$serializer","originalSerializer","serializer","customSerializer","createSerializerFromSerialProcessors","getDefaultSerializer","props","bundle","baseJSBundle","bundleToString","processor","finalSerializer"],"sources":["../src/serializer.ts"],"sourcesContent":["/**\n * Copyright Â© 2022 650 Industries.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport type { Graph, Module, SerializerOptions } from 'metro';\nimport { ConfigT, InputConfigT } from 'metro-config';\nimport baseJSBundle from 'metro/src/DeltaBundler/Serializers/baseJSBundle';\nimport bundleToString from 'metro/src/lib/bundleToString';\n\nconst debug = require('debug')('expo:metro-config:serializer') as typeof console.log;\n\ntype Serializer = NonNullable<ConfigT['serializer']['customSerializer']>;\n\ntype SerializerParameters = Parameters<Serializer>;\n\n// A serializer that processes the input and returns a modified version.\n// Unlike a serializer, these can be chained together.\ntype SerialProcessor = (...props: SerializerParameters) => SerializerParameters;\n\nexport function replaceEnvironmentVariables(\n  code: string,\n  env: Record<string, string | undefined>\n): string {\n  // match and replace env variables that aren't NODE_ENV or JEST_WORKER_ID\n  // return code.match(/process\\.env\\.(EXPO_PUBLIC_[A-Z_]+)/g);\n  return code.replace(/process\\.env\\.([a-zA-Z0-9_]+)/gm, (match) => {\n    const name = match.replace('process.env.', '');\n    if (\n      // Must start with EXPO_PUBLIC_ to be replaced\n      !/^EXPO_PUBLIC_/.test(name)\n    ) {\n      return match;\n    }\n\n    const value = JSON.stringify(env[name] ?? '');\n    debug(`Inlining environment variable \"${match}\" with ${value}`);\n    return value;\n  });\n}\n\nexport function getTransformEnvironment(url: string): string | null {\n  const match = url.match(/[&?]transform\\.environment=([^&]+)/);\n  return match ? match[1] : null;\n}\n\nexport function serializeWithEnvironmentVariables(\n  entryPoint: string,\n  preModules: readonly Module[],\n  graph: Graph,\n  options: SerializerOptions\n): SerializerParameters {\n  // Skip replacement in Node.js environments.\n  if (options.sourceUrl && getTransformEnvironment(options.sourceUrl) === 'node') {\n    debug('Skipping environment variable inlining in Node.js environment.');\n    return [entryPoint, preModules, graph, options];\n  }\n\n  // Adds about 5ms on a blank Expo Router app.\n  // TODO: We can probably cache the results.\n\n  for (const value of graph.dependencies.values()) {\n    // Skip node_modules, the feature is a bit too sensitive to allow in arbitrary code.\n    if (/node_modules/.test(value.path)) {\n      continue;\n    }\n\n    for (const index in value.output) {\n      // TODO: This probably breaks source maps.\n      const code = replaceEnvironmentVariables(value.output[index].data.code, process.env);\n      value.output[index].data.code = code;\n    }\n  }\n\n  return [entryPoint, preModules, graph, options];\n}\n\nexport function withExpoSerializers(config: InputConfigT): InputConfigT {\n  return withSerialProcessors(config, [serializeWithEnvironmentVariables]);\n}\n\n// There can only be one custom serializer as the input doesn't match the output.\n// Here we simply run\nexport function withSerialProcessors(\n  config: InputConfigT,\n  processors: SerialProcessor[]\n): InputConfigT {\n  const originalSerializer = config.serializer?.customSerializer;\n\n  return {\n    ...config,\n    serializer: {\n      ...config.serializer,\n      customSerializer: createSerializerFromSerialProcessors(processors, originalSerializer),\n    },\n  };\n}\n\nfunction getDefaultSerializer(): Serializer {\n  return (...props: SerializerParameters): string => {\n    const bundle = baseJSBundle(...props);\n    return bundleToString(bundle).code;\n  };\n}\n\nexport function createSerializerFromSerialProcessors(\n  processors: (SerialProcessor | undefined)[],\n  serializer?: Serializer\n): Serializer {\n  return (...props: SerializerParameters): ReturnType<Serializer> => {\n    for (const processor of processors) {\n      if (processor) {\n        props = processor(...props);\n      }\n    }\n\n    const finalSerializer = serializer ?? getDefaultSerializer();\n    return finalSerializer(...props);\n  };\n}\n"],"mappings":"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"}