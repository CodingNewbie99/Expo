{"version":3,"file":"babel-transformer.js","names":["_core","data","require","_inlineRequires","_interopRequireDefault","_hmr","_nodeAssert","_nodeCrypto","_nodeFs","_nodePath","_resolveFrom","obj","__esModule","default","cacheKeyParts","fs","readFileSync","__filename","version","isTypeScriptSource","fileName","endsWith","isTSXSource","babelPresetExpo","getBabelPresetExpo","projectRoot","_resolveFrom$silent","undefined","resolveFrom","silent","getBabelRC","babelRC","_getBabelRC","extendsBabelConfigPath","options","plugins","extends","projectBabelRCPath","path","resolve","existsSync","experimentalImportSupport","presetOptions","presets","disableImportExportTransform","enableBabelRuntime","buildBabelConfig","filename","extraConfig","babelrc","enableBabelRCLookup","code","cwd","highlightCode","config","extraPlugins","inlineRequires","push","inlineRequiresPlugin","withExtrPlugins","concat","dev","hot","mayContainEditableReactComponents","includes","hmrConfig","makeHMRConfig","transform","src","_getBabelPresetExpo","OLD_BABEL_ENV","process","env","BABEL_ENV","_options$customTransf","babelConfig","sourceType","caller","name","bundler","platform","environment","customTransformOptions","ast","cloneInputAst","sourceAst","hermesParser","parseSync","parse","babel","result","transformFromAstSync","assert","metadata","getCacheKey","key","crypto","createHash","forEach","part","update","digest","babelTransformer","module","exports"],"sources":["../src/babel-transformer.ts"],"sourcesContent":["/**\n * Copyright (c) 650 Industries (Expo). All rights reserved.\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n// A fork of the upstream babel-transformer that uses Expo-specific babel defaults\n// and adds support for web and Node.js environments.\n\nimport { parseSync, PluginItem, transformFromAstSync } from '@babel/core';\n// @ts-expect-error\nimport inlineRequiresPlugin from 'babel-preset-fbjs/plugins/inline-requires';\nimport type { BabelTransformer, BabelTransformerArgs } from 'metro-babel-transformer';\n// @ts-expect-error\nimport makeHMRConfig from 'metro-react-native-babel-preset/src/configs/hmr';\nimport assert from 'node:assert';\nimport crypto from 'node:crypto';\nimport fs from 'node:fs';\nimport path from 'node:path';\nimport resolveFrom from 'resolve-from';\n\nconst cacheKeyParts = [\n  fs.readFileSync(__filename),\n  require('babel-preset-fbjs/package.json').version,\n];\n\n// TS detection conditions copied from metro-react-native-babel-preset\nfunction isTypeScriptSource(fileName: string): boolean {\n  return !!fileName && fileName.endsWith('.ts');\n}\n\nfunction isTSXSource(fileName: string): boolean {\n  return !!fileName && fileName.endsWith('.tsx');\n}\n\nlet babelPresetExpo: string | null | undefined = null;\n\nfunction getBabelPresetExpo(projectRoot: string): string | null {\n  if (babelPresetExpo !== undefined) {\n    return babelPresetExpo;\n  }\n\n  babelPresetExpo = resolveFrom.silent(projectRoot, 'babel-preset-expo') ?? null;\n  return babelPresetExpo;\n}\n\n/**\n * Return a memoized function that checks for the existence of a\n * project level .babelrc file, and if it doesn't exist, reads the\n * default RN babelrc file and uses that.\n */\nconst getBabelRC = (function () {\n  let babelRC: any | null /*: ?BabelCoreOptions */ = null;\n\n  /* $FlowFixMe[missing-local-annot] The type annotation(s) required by Flow's\n   * LTI update could not be added via codemod */\n  return function _getBabelRC({\n    projectRoot,\n    extendsBabelConfigPath,\n    ...options\n  }: BabelTransformerArgs['options']) {\n    if (babelRC != null) {\n      return babelRC;\n    }\n\n    babelRC = {\n      plugins: [],\n      extends: extendsBabelConfigPath,\n    };\n\n    if (extendsBabelConfigPath) {\n      return babelRC;\n    }\n\n    // Let's look for a babel config file in the project root.\n    let projectBabelRCPath;\n\n    // .babelrc\n    if (projectRoot) {\n      projectBabelRCPath = path.resolve(projectRoot, '.babelrc');\n    }\n\n    if (projectBabelRCPath) {\n      // .babelrc.js\n      if (!fs.existsSync(projectBabelRCPath)) {\n        projectBabelRCPath = path.resolve(projectRoot, '.babelrc.js');\n      }\n\n      // babel.config.js\n      if (!fs.existsSync(projectBabelRCPath)) {\n        projectBabelRCPath = path.resolve(projectRoot, 'babel.config.js');\n      }\n\n      // If we found a babel config file, extend our config off of it\n      // otherwise the default config will be used\n      if (fs.existsSync(projectBabelRCPath)) {\n        // $FlowFixMe[incompatible-use] `extends` is missing in null or undefined.\n        babelRC.extends = projectBabelRCPath;\n      }\n    }\n\n    // If a babel config file doesn't exist in the project then\n    // the default preset for react-native will be used instead.\n    // $FlowFixMe[incompatible-use] `extends` is missing in null or undefined.\n    // $FlowFixMe[incompatible-type] `extends` is missing in null or undefined.\n    if (!babelRC.extends) {\n      const { experimentalImportSupport, ...presetOptions } = options;\n\n      // $FlowFixMe[incompatible-use] `presets` is missing in null or undefined.\n      babelRC.presets = [\n        [\n          require('metro-react-native-babel-preset'),\n          {\n            projectRoot,\n            ...presetOptions,\n            disableImportExportTransform: experimentalImportSupport,\n            enableBabelRuntime: options.enableBabelRuntime,\n          },\n        ],\n      ];\n    }\n\n    return babelRC;\n  };\n})();\n\n/**\n * Given a filename and options, build a Babel\n * config object with the appropriate plugins.\n */\nfunction buildBabelConfig(\n  filename: string,\n  options: BabelTransformerArgs['options'],\n  plugins: PluginItem[] = []\n) /*: BabelCoreOptions*/ {\n  const babelRC = getBabelRC(options);\n\n  const extraConfig /*: BabelCoreOptions */ = {\n    babelrc: typeof options.enableBabelRCLookup === 'boolean' ? options.enableBabelRCLookup : true,\n    code: false,\n    cwd: options.projectRoot,\n    filename,\n    highlightCode: true,\n  };\n\n  let config /*: BabelCoreOptions */ = {\n    ...babelRC,\n    ...extraConfig,\n  };\n\n  // Add extra plugins\n  const extraPlugins = [];\n\n  if (options.inlineRequires) {\n    extraPlugins.push(inlineRequiresPlugin);\n  }\n\n  const withExtrPlugins = (config.plugins = extraPlugins.concat(config.plugins, plugins));\n\n  if (options.dev && options.hot) {\n    // Note: this intentionally doesn't include the path separator because\n    // I'm not sure which one it should use on Windows, and false positives\n    // are unlikely anyway. If you later decide to include the separator,\n    // don't forget that the string usually *starts* with \"node_modules\" so\n    // the first one often won't be there.\n    const mayContainEditableReactComponents = !filename.includes('node_modules');\n\n    if (mayContainEditableReactComponents) {\n      const hmrConfig = makeHMRConfig();\n      hmrConfig.plugins = withExtrPlugins.concat(hmrConfig.plugins);\n      config = { ...config, ...hmrConfig };\n    }\n  }\n\n  return {\n    ...babelRC,\n    ...config,\n  };\n}\n\nconst transform: BabelTransformer['transform'] = ({\n  filename,\n  options,\n  src,\n  plugins,\n}: BabelTransformerArgs): ReturnType<BabelTransformer['transform']> => {\n  const OLD_BABEL_ENV = process.env.BABEL_ENV;\n  process.env.BABEL_ENV = options.dev ? 'development' : process.env.BABEL_ENV || 'production';\n\n  // Ensure the default babel preset is Expo.\n  options.extendsBabelConfigPath = getBabelPresetExpo(options.projectRoot) ?? undefined;\n\n  try {\n    const babelConfig = {\n      // ES modules require sourceType='module' but OSS may not always want that\n      sourceType: 'unambiguous',\n      ...buildBabelConfig(filename, options, plugins),\n      caller: {\n        name: 'metro',\n        bundler: 'metro',\n        platform: options.platform,\n        // Empower the babel preset to know the env it's bundling for.\n        // Metro automatically updates the cache to account for the custom transform options.\n        // client | node | undefined\n        environment: options.customTransformOptions?.environment,\n      },\n      ast: true,\n\n      // NOTE(EvanBacon): We split the parse/transform steps up to accommodate\n      // Hermes parsing, but this defaults to cloning the AST which increases\n      // the transformation time by a fair amount.\n      // You get this behavior by default when using Babel's `transform` method directly.\n      cloneInputAst: false,\n    };\n    const sourceAst =\n      isTypeScriptSource(filename) || isTSXSource(filename) || !options.hermesParser\n        ? parseSync(src, babelConfig)\n        : require('hermes-parser').parse(src, {\n            babel: true,\n            sourceType: babelConfig.sourceType,\n          });\n\n    const result = transformFromAstSync(sourceAst, src, babelConfig);\n\n    // The result from `transformFromAstSync` can be null (if the file is ignored)\n    if (!result) {\n      // BabelTransformer specifies that the `ast` can never be null but\n      // the function returns here. Discovered when typing `BabelNode`.\n      return { ast: null };\n    }\n\n    assert(result.ast);\n    return { ast: result.ast, metadata: result.metadata };\n  } finally {\n    if (OLD_BABEL_ENV) {\n      process.env.BABEL_ENV = OLD_BABEL_ENV;\n    }\n  }\n};\n\nfunction getCacheKey() {\n  const key = crypto.createHash('md5');\n  cacheKeyParts.forEach((part) => key.update(part));\n  return key.digest('hex');\n}\n\nconst babelTransformer: BabelTransformer = {\n  transform,\n  getCacheKey,\n};\n\nmodule.exports = babelTransformer;\n"],"mappings":"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"}