{"version":3,"file":"ExpoMetroConfig.js","names":["debug","require","getProjectBabelConfigFile","projectRoot","resolveFrom","silent","getAssetPlugins","hashAssetFilesPath","Error","getServerRoot","env","EXPO_USE_METRO_WORKSPACE_ROOT","getWorkspaceRoot","hasWarnedAboutExotic","getDefaultConfig","options","isExotic","mode","EXPO_USE_EXOTIC","console","log","chalk","gray","bold","reactNativePath","path","dirname","babelPresetFbjsPath","process","EXPO_METRO_CACHE_KEY_VERSION","String","version","sourceExtsConfig","isTS","isReact","isModern","sourceExts","getBareExtensions","push","babelConfigPath","isCustomBabelConfigDefined","resolverMainFields","watchFolders","getWatchFolders","nodeModulesPaths","getModulesPaths","EXPO_DEBUG","join","reporter","metroDefaultValues","getDefaultMetroConfig","getDefaultValues","mergeConfig","resolver","platforms","assetExts","concat","filter","assetExt","includes","serializer","getModulesRunBeforeMainModule","resolve","getPolyfills","server","rewriteRequestUrl","url","startsWith","search","searchParams","URL","platform","get","serverRoot","entry","resolveEntryPoint","projectConfig","pkg","getPackageJson","port","Number","RCT_METRO_PORT","unstable_serverRoot","symbolicator","customizeFrame","getDefaultCustomizeFrame","transformer","unstable_allowRequireContext","allowOptionalDependencies","babelTransformerPath","assetRegistryPath","assetPlugins","loadAsync","metroOptions","defaultConfig","loadConfig","cwd"],"sources":["../src/ExpoMetroConfig.ts"],"sourcesContent":["// Copyright 2023-present 650 Industries (Expo). All rights reserved.\nimport { getPackageJson } from '@expo/config';\nimport { getBareExtensions, resolveEntryPoint } from '@expo/config/paths';\nimport chalk from 'chalk';\nimport { Reporter } from 'metro';\nimport {\n  ConfigT as MetroConfig,\n  getDefaultConfig as getDefaultMetroConfig,\n  InputConfigT,\n  loadConfig,\n  mergeConfig,\n} from 'metro-config';\nimport path from 'path';\nimport resolveFrom from 'resolve-from';\n\nimport { getDefaultCustomizeFrame, INTERNAL_CALLSITES_REGEX } from './customizeFrame';\nimport { env } from './env';\nimport { getModulesPaths, getWorkspaceRoot } from './getModulesPaths';\nimport { getWatchFolders } from './getWatchFolders';\n\nconst debug = require('debug')('expo:metro:config');\n\nexport interface LoadOptions {\n  config?: string;\n  maxWorkers?: number;\n  port?: number;\n  reporter?: Reporter;\n  resetCache?: boolean;\n}\n\nexport interface DefaultConfigOptions {\n  mode?: 'exotic';\n}\n\nfunction getProjectBabelConfigFile(projectRoot: string): string | undefined {\n  return (\n    resolveFrom.silent(projectRoot, './babel.config.js') ||\n    resolveFrom.silent(projectRoot, './.babelrc') ||\n    resolveFrom.silent(projectRoot, './.babelrc.js')\n  );\n}\n\nfunction getAssetPlugins(projectRoot: string): string[] {\n  const hashAssetFilesPath = resolveFrom.silent(projectRoot, 'expo-asset/tools/hashAssetFiles');\n\n  if (!hashAssetFilesPath) {\n    throw new Error(`The required package \\`expo-asset\\` cannot be found`);\n  }\n\n  return [hashAssetFilesPath];\n}\n\nfunction getServerRoot(projectRoot: string) {\n  return env.EXPO_USE_METRO_WORKSPACE_ROOT\n    ? getWorkspaceRoot(projectRoot) ?? projectRoot\n    : projectRoot;\n}\n\nlet hasWarnedAboutExotic = false;\n\nexport function getDefaultConfig(\n  projectRoot: string,\n  options: DefaultConfigOptions = {}\n): InputConfigT {\n  const isExotic = options.mode === 'exotic' || env.EXPO_USE_EXOTIC;\n\n  if (isExotic && !hasWarnedAboutExotic) {\n    hasWarnedAboutExotic = true;\n    console.log(\n      chalk.gray(\n        `\\u203A Unstable feature ${chalk.bold`EXPO_USE_EXOTIC`} is enabled. Bundling may not work as expected, and is subject to breaking changes.`\n      )\n    );\n  }\n\n  const reactNativePath = path.dirname(resolveFrom(projectRoot, 'react-native/package.json'));\n\n  try {\n    // Set the `EXPO_METRO_CACHE_KEY_VERSION` variable for use in the custom babel transformer.\n    // This hack is used because there doesn't appear to be anyway to resolve\n    // `babel-preset-fbjs` relative to the project root later (in `metro-expo-babel-transformer`).\n    const babelPresetFbjsPath = resolveFrom(projectRoot, 'babel-preset-fbjs/package.json');\n    process.env.EXPO_METRO_CACHE_KEY_VERSION = String(require(babelPresetFbjsPath).version);\n  } catch {\n    // noop -- falls back to a hardcoded value.\n  }\n\n  const sourceExtsConfig = { isTS: true, isReact: true, isModern: false };\n  const sourceExts = getBareExtensions([], sourceExtsConfig);\n\n  if (isExotic) {\n    // Add support for cjs (without platform extensions).\n    sourceExts.push('cjs');\n  }\n\n  const babelConfigPath = getProjectBabelConfigFile(projectRoot);\n  const isCustomBabelConfigDefined = !!babelConfigPath;\n\n  const resolverMainFields: string[] = [];\n\n  // Disable `react-native` in exotic mode, since library authors\n  // use it to ship raw application code to the project.\n  if (!isExotic) {\n    resolverMainFields.push('react-native');\n  }\n  resolverMainFields.push('browser', 'main');\n\n  const watchFolders = getWatchFolders(projectRoot);\n  // TODO: nodeModulesPaths does not work with the new Node.js package.json exports API, this causes packages like uuid to fail. Disabling for now.\n  const nodeModulesPaths = getModulesPaths(projectRoot);\n  if (env.EXPO_DEBUG) {\n    console.log();\n    console.log(`Expo Metro config:`);\n    try {\n      console.log(`- Version: ${require('../package.json').version}`);\n    } catch {}\n    console.log(`- Extensions: ${sourceExts.join(', ')}`);\n    console.log(`- React Native: ${reactNativePath}`);\n    console.log(`- Babel config: ${babelConfigPath || 'babel-preset-expo (default)'}`);\n    console.log(`- Resolver Fields: ${resolverMainFields.join(', ')}`);\n    console.log(`- Watch Folders: ${watchFolders.join(', ')}`);\n    console.log(`- Node Module Paths: ${nodeModulesPaths.join(', ')}`);\n    console.log(`- Exotic: ${isExotic}`);\n    console.log();\n  }\n  const {\n    // Remove the default reporter which metro always resolves to be the react-native-community/cli reporter.\n    // This prints a giant React logo which is less accessible to users on smaller terminals.\n    reporter,\n    ...metroDefaultValues\n  } = getDefaultMetroConfig.getDefaultValues(projectRoot);\n\n  // Merge in the default config from Metro here, even though loadConfig uses it as defaults.\n  // This is a convenience for getDefaultConfig use in metro.config.js, e.g. to modify assetExts.\n  return mergeConfig(metroDefaultValues, {\n    watchFolders,\n    resolver: {\n      resolverMainFields,\n      platforms: ['ios', 'android'],\n      assetExts: metroDefaultValues.resolver.assetExts\n        .concat(\n          // Add default support for `expo-image` file types.\n          ['heic', 'avif']\n        )\n        .filter((assetExt) => !sourceExts.includes(assetExt)),\n      sourceExts,\n      nodeModulesPaths,\n    },\n    serializer: {\n      getModulesRunBeforeMainModule: () => [\n        require.resolve(path.join(reactNativePath, 'Libraries/Core/InitializeCore')),\n        // TODO: Bacon: load Expo side-effects\n      ],\n      getPolyfills: () => require(path.join(reactNativePath, 'rn-get-polyfills'))(),\n    },\n    server: {\n      rewriteRequestUrl(url: string): string {\n        // Like: `/.expo/find-entry.bundle?platform=ios&dev=true&minify=false&modulesOnly=false&runModule=true&app=com.bacon.test-custom-entry`\n        if (url.startsWith('/.expo/find-entry.bundle')) {\n          // TODO: Maybe this function could be memoized in some capacity?\n          const { search, searchParams } = new URL(url, 'https://acme.dev');\n\n          const platform = searchParams.get('platform') ?? 'web';\n\n          debug('Rewriting magic request url to entry point', { url, platform });\n\n          const serverRoot = getServerRoot(projectRoot);\n          const entry = resolveEntryPoint(serverRoot, {\n            platform,\n            projectConfig: {\n              pkg: getPackageJson(projectRoot),\n            },\n          });\n\n          if (!entry) {\n            throw new Error(\n              chalk`The project entry file could not be resolved (platform: ${platform}, root: ${projectRoot}). Define it in the {bold package.json} \"main\" field.`\n            );\n          }\n\n          // Like: `/index.bundle?platform=ios&dev=true&minify=false&modulesOnly=false&runModule=true&app=com.bacon.test-custom-entry`\n          return '/' + entry + '.bundle' + search;\n        }\n        return url;\n      },\n      port: Number(env.RCT_METRO_PORT) || 8081,\n      // NOTE(EvanBacon): Moves the server root down to the monorepo root.\n      // This enables proper monorepo support for web.\n      // @ts-expect-error: not on type\n      unstable_serverRoot: getServerRoot(projectRoot),\n    },\n    symbolicator: {\n      customizeFrame: getDefaultCustomizeFrame(),\n    },\n    transformer: {\n      // `require.context` support\n      unstable_allowRequireContext: true,\n      allowOptionalDependencies: true,\n      babelTransformerPath: isExotic\n        ? require.resolve('./transformer/metro-expo-exotic-babel-transformer')\n        : isCustomBabelConfigDefined\n        ? // If the user defined a babel config file in their project,\n          // then use the default transformer.\n          // Try to use the project copy before falling back on the global version\n          resolveFrom.silent(projectRoot, 'metro-react-native-babel-transformer')\n        : // Otherwise, use a custom transformer that uses `babel-preset-expo` by default for projects.\n          require.resolve('./transformer/metro-expo-babel-transformer'),\n      assetRegistryPath: 'react-native/Libraries/Image/AssetRegistry',\n      assetPlugins: getAssetPlugins(projectRoot),\n    },\n  });\n}\n\nexport async function loadAsync(\n  projectRoot: string,\n  { reporter, ...metroOptions }: LoadOptions = {}\n): Promise<MetroConfig> {\n  let defaultConfig = getDefaultConfig(projectRoot);\n  if (reporter) {\n    defaultConfig = { ...defaultConfig, reporter };\n  }\n  return await loadConfig({ cwd: projectRoot, projectRoot, ...metroOptions }, defaultConfig);\n}\n\n// re-export for use in config files.\nexport { MetroConfig, INTERNAL_CALLSITES_REGEX };\n\n// re-export for legacy cases.\nexport const EXPO_DEBUG = env.EXPO_DEBUG;\n"],"mappings":"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"}