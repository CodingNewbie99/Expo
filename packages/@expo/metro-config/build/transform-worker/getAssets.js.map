{"version":3,"file":"getAssets.js","names":["_Assets","data","require","_js","_nodeAssert","_interopRequireDefault","_nodePath","obj","__esModule","default","assertHashedAssetData","assert","getUniversalAssetData","assetPath","localPath","assetDataPlugins","platform","publicPath","getAssetData","getAssets","dependencies","options","promises","processModuleFilter","module","values","isJsModule","getJsOutput","type","path","relative","projectRoot","push","assetPlugins","Promise","all"],"sources":["../../src/transform-worker/getAssets.ts"],"sourcesContent":["/**\n * Copyright 2023-present 650 Industries (Expo). All rights reserved.\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport { AssetData, Module } from 'metro';\nimport { getAssetData } from 'metro/src/Assets';\nimport { getJsOutput, isJsModule } from 'metro/src/DeltaBundler/Serializers/helpers/js';\nimport assert from 'node:assert';\n// import crypto from 'node:crypto';\nimport path from 'node:path';\n\nimport { ReadOnlyDependencies } from '../serializer/getCssDeps';\n\ntype Options = {\n  processModuleFilter: (modules: Module) => boolean;\n  assetPlugins: readonly string[];\n  platform?: string | null;\n  projectRoot: string;\n  publicPath: string;\n};\n\n// function md5Hash(data: string) {\n//   const hash = crypto.createHash('md5');\n//   hash.update(data);\n//   return hash.digest('hex');\n// }\n\nfunction assertHashedAssetData(data: AssetData): asserts data is HashedAssetData {\n  assert(\n    'fileHashes' in data,\n    'Assets must have hashed files. Ensure the expo-asset plugin is installed.'\n  );\n}\n\nexport async function getUniversalAssetData(\n  assetPath: string,\n  localPath: string,\n  assetDataPlugins: readonly string[],\n  platform: string | null | undefined,\n  publicPath: string\n): Promise<HashedAssetData> {\n  const data = await getAssetData(assetPath, localPath, assetDataPlugins, platform, publicPath);\n  assertHashedAssetData(data);\n\n  // NOTE(EvanBacon): This is where we modify the asset to include a hash in the name for web cache invalidation.\n  //   if (platform === 'web' && publicPath.includes('?export_path=')) {\n  //     // Store original name for reading the asset on-disk later.\n  //     data._name = data.name;\n  //     // `local-image.[contenthash]`. Using `.` but this won't work if we ever apply to Android because Android res files cannot contain `.`.\n  //     // TODO: Prevent one multi-res image from updating the hash in all images.\n  //     // @ts-expect-error: name is typed as readonly.\n  //     data.name = `${data.name}.${md5Hash(data.fileHashes.join(''))}`;\n  //   }\n\n  return data;\n}\n\nexport type HashedAssetData = AssetData & { fileHashes: string[]; _name?: string };\n\nexport default async function getAssets(\n  dependencies: ReadOnlyDependencies,\n  options: Options\n): Promise<HashedAssetData[]> {\n  const promises: Promise<HashedAssetData>[] = [];\n  const { processModuleFilter } = options;\n\n  for (const module of dependencies.values()) {\n    if (\n      isJsModule(module) &&\n      processModuleFilter(module) &&\n      getJsOutput(module).type === 'js/module/asset' &&\n      path.relative(options.projectRoot, module.path) !== 'package.json'\n    ) {\n      promises.push(\n        getUniversalAssetData(\n          module.path,\n          path.relative(options.projectRoot, module.path),\n          options.assetPlugins,\n          options.platform,\n          options.publicPath\n        )\n      );\n    }\n  }\n\n  return await Promise.all(promises);\n}\n"],"mappings":";;;;;;;AAQA,SAAAA,QAAA;EAAA,MAAAC,IAAA,GAAAC,OAAA;EAAAF,OAAA,YAAAA,CAAA;IAAA,OAAAC,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AACA,SAAAE,IAAA;EAAA,MAAAF,IAAA,GAAAC,OAAA;EAAAC,GAAA,YAAAA,CAAA;IAAA,OAAAF,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AACA,SAAAG,YAAA;EAAA,MAAAH,IAAA,GAAAI,sBAAA,CAAAH,OAAA;EAAAE,WAAA,YAAAA,CAAA;IAAA,OAAAH,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AAEA,SAAAK,UAAA;EAAA,MAAAL,IAAA,GAAAI,sBAAA,CAAAH,OAAA;EAAAI,SAAA,YAAAA,CAAA;IAAA,OAAAL,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AAA6B,SAAAI,uBAAAE,GAAA,WAAAA,GAAA,IAAAA,GAAA,CAAAC,UAAA,GAAAD,GAAA,KAAAE,OAAA,EAAAF,GAAA;AAZ7B;AACA;AACA;AACA;AACA;AACA;AACA;;AAKA;;AAaA;AACA;AACA;AACA;AACA;;AAEA,SAASG,qBAAqBA,CAACT,IAAe,EAAmC;EAC/E,IAAAU,qBAAM,EACJ,YAAY,IAAIV,IAAI,EACpB,2EAA2E,CAC5E;AACH;AAEO,eAAeW,qBAAqBA,CACzCC,SAAiB,EACjBC,SAAiB,EACjBC,gBAAmC,EACnCC,QAAmC,EACnCC,UAAkB,EACQ;EAC1B,MAAMhB,IAAI,GAAG,MAAM,IAAAiB,sBAAY,EAACL,SAAS,EAAEC,SAAS,EAAEC,gBAAgB,EAAEC,QAAQ,EAAEC,UAAU,CAAC;EAC7FP,qBAAqB,CAACT,IAAI,CAAC;;EAE3B;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA,OAAOA,IAAI;AACb;AAIe,eAAekB,SAASA,CACrCC,YAAkC,EAClCC,OAAgB,EACY;EAC5B,MAAMC,QAAoC,GAAG,EAAE;EAC/C,MAAM;IAAEC;EAAoB,CAAC,GAAGF,OAAO;EAEvC,KAAK,MAAMG,MAAM,IAAIJ,YAAY,CAACK,MAAM,EAAE,EAAE;IAC1C,IACE,IAAAC,gBAAU,EAACF,MAAM,CAAC,IAClBD,mBAAmB,CAACC,MAAM,CAAC,IAC3B,IAAAG,iBAAW,EAACH,MAAM,CAAC,CAACI,IAAI,KAAK,iBAAiB,IAC9CC,mBAAI,CAACC,QAAQ,CAACT,OAAO,CAACU,WAAW,EAAEP,MAAM,CAACK,IAAI,CAAC,KAAK,cAAc,EAClE;MACAP,QAAQ,CAACU,IAAI,CACXpB,qBAAqB,CACnBY,MAAM,CAACK,IAAI,EACXA,mBAAI,CAACC,QAAQ,CAACT,OAAO,CAACU,WAAW,EAAEP,MAAM,CAACK,IAAI,CAAC,EAC/CR,OAAO,CAACY,YAAY,EACpBZ,OAAO,CAACL,QAAQ,EAChBK,OAAO,CAACJ,UAAU,CACnB,CACF;IACH;EACF;EAEA,OAAO,MAAMiB,OAAO,CAACC,GAAG,CAACb,QAAQ,CAAC;AACpC"}