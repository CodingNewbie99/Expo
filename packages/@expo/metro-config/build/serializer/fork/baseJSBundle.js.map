{"version":3,"file":"baseJSBundle.js","names":["_jscSafeUrl","data","require","_getAppendScripts","_interopRequireDefault","_processModules","obj","__esModule","default","getPlatformOption","graph","options","_url$searchParams$get","transformOptions","platform","sourceUrl","isJscSafeUrl","toNormalUrl","url","URL","searchParams","get","baseJSBundle","entryPoint","preModules","Error","baseJSBundleWithDependencies","dependencies","values","module","createModuleId","path","processModulesOptions","filter","processModuleFilter","dev","includeAsyncPaths","projectRoot","serverRoot","modulesOnly","preCode","processModules","map","code","src","join","modules","sort","a","b","postCode","getAppendScripts","asyncRequireModulePath","getRunModuleStatement","inlineSourceMap","runBeforeMainModule","runModule","shouldAddToIgnoreList","sourceMapUrl","mods","pre","post","id","_expoSplitBundlePaths","paths"],"sources":["../../../src/serializer/fork/baseJSBundle.ts"],"sourcesContent":["/**\n * Copyright Â© 2022 650 Industries.\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * Fork with bundle splitting and better source map support.\n * https://github.com/facebook/metro/blob/bbdd7d7c5e6e0feb50a9967ffae1f723c1d7c4e8/packages/metro/src/DeltaBundler/Serializers/baseJSBundle.js#L1\n */\n\nimport { isJscSafeUrl, toNormalUrl } from 'jsc-safe-url';\nimport type { MixedOutput, Module, ReadOnlyGraph, SerializerOptions } from 'metro';\nimport getAppendScripts from 'metro/src/lib/getAppendScripts';\n\nimport { processModules } from './processModules';\n\nexport type ModuleMap = [number, string][];\n\nexport type Bundle = {\n  modules: ModuleMap;\n  post: string;\n  pre: string;\n  _expoSplitBundlePaths: [number, Record<string, string>][];\n};\n\nexport function getPlatformOption(\n  graph: Pick<ReadOnlyGraph, 'transformOptions'>,\n  options: SerializerOptions\n): string | null {\n  if (graph.transformOptions.platform != null) {\n    return graph.transformOptions.platform;\n  }\n  if (!options.sourceUrl) {\n    return null;\n  }\n\n  const sourceUrl = isJscSafeUrl(options.sourceUrl)\n    ? toNormalUrl(options.sourceUrl)\n    : options.sourceUrl;\n  const url = new URL(sourceUrl, 'https://expo.dev');\n  return url.searchParams.get('platform') ?? null;\n}\n\nexport function baseJSBundle(\n  entryPoint: string,\n  preModules: readonly Module[],\n  graph: Pick<ReadOnlyGraph, 'dependencies' | 'transformOptions'>,\n  options: SerializerOptions\n): Bundle {\n  const platform = getPlatformOption(graph, options);\n  if (platform == null) {\n    throw new Error('platform could not be determined for Metro bundle');\n  }\n\n  return baseJSBundleWithDependencies(entryPoint, preModules, [...graph.dependencies.values()], {\n    ...options,\n    platform,\n  });\n}\n\nexport function baseJSBundleWithDependencies(\n  entryPoint: string,\n  preModules: readonly Module[],\n  dependencies: Module<MixedOutput>[],\n  options: SerializerOptions & { platform: string }\n): Bundle {\n  for (const module of dependencies) {\n    options.createModuleId(module.path);\n  }\n\n  const processModulesOptions = {\n    filter: options.processModuleFilter,\n    createModuleId: options.createModuleId,\n    dev: options.dev,\n    includeAsyncPaths: options.includeAsyncPaths,\n    projectRoot: options.projectRoot,\n    serverRoot: options.serverRoot,\n    sourceUrl: options.sourceUrl,\n    platform: options.platform,\n  };\n\n  // Do not prepend polyfills or the require runtime when only modules are requested\n  if (options.modulesOnly) {\n    preModules = [];\n  }\n\n  const preCode = processModules(preModules, processModulesOptions)\n    .map(([, code]) => code.src)\n    .join('\\n');\n\n  const modules = [...dependencies].sort(\n    (a: Module<MixedOutput>, b: Module<MixedOutput>) =>\n      options.createModuleId(a.path) - options.createModuleId(b.path)\n  );\n\n  const postCode = processModules(\n    getAppendScripts(entryPoint, [...preModules, ...modules], {\n      asyncRequireModulePath: options.asyncRequireModulePath,\n      createModuleId: options.createModuleId,\n      getRunModuleStatement: options.getRunModuleStatement,\n      inlineSourceMap: options.inlineSourceMap,\n      runBeforeMainModule: options.runBeforeMainModule,\n      runModule: options.runModule,\n      shouldAddToIgnoreList: options.shouldAddToIgnoreList,\n      sourceMapUrl: options.sourceMapUrl,\n      sourceUrl: options.sourceUrl,\n    }),\n    processModulesOptions\n  )\n    .map(([, code]) => code.src)\n    .join('\\n');\n\n  const mods = processModules([...dependencies], processModulesOptions).map(([module, code]) => [\n    options.createModuleId(module.path),\n    code,\n  ]);\n  return {\n    pre: preCode,\n    post: postCode,\n    modules: mods.map(([id, code]) => [\n      id,\n      typeof code === 'number' ? code : code.src,\n    ]) as ModuleMap,\n    _expoSplitBundlePaths: mods.map(([id, code]) => [\n      id,\n      typeof code === 'number' ? {} : code.paths,\n    ]) as [number, Record<string, string>][],\n  };\n}\n"],"mappings":"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"}