{"version":3,"file":"serializeChunks.js","names":["_assert","data","_interopRequireDefault","require","_getAssets","_sourceMapString","_bundleToString","_path","_pathToRegexp","_exportHermes","_exportPath","_baseJSBundle","_getCssDeps","obj","__esModule","default","_defineProperty","key","value","_toPropertyKey","Object","defineProperty","enumerable","configurable","writable","arg","_toPrimitive","String","input","hint","prim","Symbol","toPrimitive","undefined","res","call","TypeError","Number","graphToSerialAssetsAsync","config","serializeChunkOptions","props","_config$serializer","_assetPlugins","_getPlatformOption","entryFile","preModules","graph","options","cssDeps","getCssSerialAssets","dependencies","projectRoot","processModuleFilter","_chunks","Set","test","pathToRegExp","map","chunkSettings","gatherChunks","jsAssets","serializeChunksAsync","serializer","metroAssets","getMetroAssets","assetPlugins","transformer","platform","getPlatformOption","publicPath","artifacts","assets","Chunk","constructor","name","entries","isAsync","deps","getPlatform","assert","transformOptions","getFilename","dev","getExportPathForDependencyWithOptions","serverRoot","serializeToCode","serializerConfig","_serializerConfig$get","_serializerConfig$get2","fileName","path","basename","jsSplitBundle","baseJSBundleWithDependencies","values","runBeforeMainModule","getModulesRunBeforeMainModule","relative","runModule","modulesOnly","size","sourceMapUrl","baseUrl","getBaseUrlOption","splitChunks","getSplitChunksOption","bundleToString","code","serializeToAssetsAsync","includeSourceMaps","includeBytecode","jsCode","relativeEntry","outputFile","jsAsset","filename","originFilename","type","metadata","requires","requiredChunks","chunk","source","modules","getSortedModules","createModuleId","module","startsWith","_this$options$serverR","sourceMap","sourceMapString","push","isHermesEnabled","hermesBundleOutput","buildHermesBundleAsync","minify","hbc","replace","sourcemap","supportsBytecode","_this$graph$transform","customTransformOptions","engine","getEntryModulesForChunkSettings","settings","filter","chunkIdForModules","sort","join","chunks","entryModules","existingChunks","find","includes","length","entryChunk","add","includeModule","entryModule","dependency","get","absolutePath","has","Promise","all","a","b"],"sources":["../../src/serializer/serializeChunks.ts"],"sourcesContent":["/**\n * Copyright Â© 2023 650 Industries.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport assert from 'assert';\nimport {\n  AssetData,\n  MetroConfig,\n  MixedOutput,\n  Module,\n  ReadOnlyGraph,\n  SerializerOptions,\n} from 'metro';\nimport getMetroAssets from 'metro/src/DeltaBundler/Serializers/getAssets';\n// @ts-expect-error\nimport sourceMapString from 'metro/src/DeltaBundler/Serializers/sourceMapString';\nimport bundleToString from 'metro/src/lib/bundleToString';\nimport { ConfigT, SerializerConfigT } from 'metro-config';\nimport path from 'path';\nimport pathToRegExp from 'path-to-regexp';\n\nimport { buildHermesBundleAsync } from './exportHermes';\nimport { getExportPathForDependencyWithOptions } from './exportPath';\nimport {\n  ExpoSerializerOptions,\n  baseJSBundleWithDependencies,\n  getBaseUrlOption,\n  getPlatformOption,\n  getSplitChunksOption,\n} from './fork/baseJSBundle';\nimport { getCssSerialAssets } from './getCssDeps';\nimport { SerialAsset } from './serializerAssets';\n\ntype Serializer = NonNullable<ConfigT['serializer']['customSerializer']>;\n\ntype SerializerParameters = Parameters<Serializer>;\n\ntype ChunkSettings = {\n  /** Match the initial modules. */\n  test: RegExp;\n};\n\nexport type SerializeChunkOptions = {\n  includeSourceMaps: boolean;\n  includeBytecode: boolean;\n};\n\nexport async function graphToSerialAssetsAsync(\n  config: MetroConfig,\n  serializeChunkOptions: SerializeChunkOptions,\n  ...props: SerializerParameters\n): Promise<{ artifacts: SerialAsset[] | null; assets: AssetData[] }> {\n  const [entryFile, preModules, graph, options] = props;\n\n  const cssDeps = getCssSerialAssets<MixedOutput>(graph.dependencies, {\n    projectRoot: options.projectRoot,\n    processModuleFilter: options.processModuleFilter,\n  });\n\n  // Create chunks for splitting.\n  const _chunks = new Set<Chunk>();\n\n  [\n    {\n      test: pathToRegExp(entryFile),\n    },\n  ].map((chunkSettings) => gatherChunks(_chunks, chunkSettings, preModules, graph, options, false));\n\n  const jsAssets = await serializeChunksAsync(\n    _chunks,\n    config.serializer ?? {},\n    serializeChunkOptions\n  );\n\n  // TODO: Convert to serial assets\n  // TODO: Disable this call dynamically in development since assets are fetched differently.\n  const metroAssets = (await getMetroAssets(graph.dependencies, {\n    processModuleFilter: options.processModuleFilter,\n    assetPlugins: config.transformer!.assetPlugins ?? [],\n    platform: getPlatformOption(graph, options) ?? 'web',\n    projectRoot: options.projectRoot, // this._getServerRootDir(),\n    publicPath: config.transformer!.publicPath!,\n  })) as AssetData[];\n\n  return { artifacts: [...jsAssets, ...cssDeps], assets: metroAssets };\n}\n\nclass Chunk {\n  public deps: Set<Module> = new Set();\n  public preModules: Set<Module> = new Set();\n\n  // Chunks that are required to be loaded synchronously before this chunk.\n  // These are included in the HTML as <script> tags.\n  public requiredChunks: Set<Chunk> = new Set();\n\n  constructor(\n    public name: string,\n    public entries: Module<MixedOutput>[],\n    public graph: ReadOnlyGraph<MixedOutput>,\n    public options: ExpoSerializerOptions,\n    public isAsync: boolean = false\n  ) {\n    this.deps = new Set(entries);\n  }\n\n  private getPlatform() {\n    assert(\n      this.graph.transformOptions.platform,\n      \"platform is required to be in graph's transformOptions\"\n    );\n    return this.graph.transformOptions.platform;\n  }\n\n  getFilename() {\n    // TODO: Content hash is needed\n    return this.options.dev\n      ? this.name\n      : getExportPathForDependencyWithOptions(this.name, {\n          platform: this.getPlatform(),\n          serverRoot: this.options.serverRoot,\n        });\n  }\n\n  serializeToCode(serializerConfig: Partial<SerializerConfigT>) {\n    const entryFile = this.name;\n    const fileName = path.basename(entryFile, '.js');\n\n    const jsSplitBundle = baseJSBundleWithDependencies(\n      entryFile,\n      [...this.preModules.values()],\n      [...this.deps],\n      {\n        ...this.options,\n        runBeforeMainModule:\n          serializerConfig?.getModulesRunBeforeMainModule?.(\n            path.relative(this.options.projectRoot, entryFile)\n          ) ?? [],\n        // searchParams.set('modulesOnly', 'true');\n        // searchParams.set('runModule', 'false');\n\n        // TODO: Test cases when an async module has global side-effects that should be run.\n        // This should be fine as those side-effects would be defined in the module itself, which would be executed upon loading.\n        runModule: !this.isAsync,\n        modulesOnly: this.preModules.size === 0,\n        platform: this.getPlatform(),\n        sourceMapUrl: `${fileName}.map`,\n        baseUrl: getBaseUrlOption(this.graph, this.options),\n        splitChunks: getSplitChunksOption(this.graph, this.options),\n      }\n    );\n\n    return bundleToString(jsSplitBundle).code;\n  }\n\n  async serializeToAssetsAsync(\n    serializerConfig: Partial<SerializerConfigT>,\n    {\n      includeSourceMaps,\n      includeBytecode,\n    }: { includeSourceMaps?: boolean; includeBytecode?: boolean }\n  ): Promise<SerialAsset[]> {\n    const jsCode = this.serializeToCode(serializerConfig);\n\n    const relativeEntry = path.relative(this.options.projectRoot, this.name);\n    const outputFile = this.getFilename();\n\n    const jsAsset: SerialAsset = {\n      filename: outputFile,\n      originFilename: relativeEntry,\n      type: 'js',\n      metadata: {\n        isAsync: this.isAsync,\n        requires: [...this.requiredChunks.values()].map((chunk) => chunk.getFilename()),\n      },\n      source: jsCode,\n    };\n\n    const assets: SerialAsset[] = [jsAsset];\n\n    if (\n      // Only include the source map if the `options.sourceMapUrl` option is provided and we are exporting a static build.\n      includeSourceMaps &&\n      this.options.sourceMapUrl\n    ) {\n      const modules = [\n        ...this.preModules,\n        ...getSortedModules([...this.deps], {\n          createModuleId: this.options.createModuleId,\n        }),\n      ].map((module) => {\n        // TODO: Make this user-configurable.\n\n        // Make all paths relative to the server root to prevent the entire user filesystem from being exposed.\n        if (module.path.startsWith('/')) {\n          return {\n            ...module,\n            path:\n              '/' + path.relative(this.options.serverRoot ?? this.options.projectRoot, module.path),\n          };\n        }\n        return module;\n      });\n\n      const sourceMap = sourceMapString(modules, {\n        ...this.options,\n      });\n\n      assets.push({\n        filename: this.options.dev ? jsAsset.filename + '.map' : outputFile + '.map',\n        originFilename: jsAsset.originFilename,\n        type: 'map',\n        metadata: {},\n        source: sourceMap,\n      });\n    }\n\n    if (includeBytecode && this.isHermesEnabled()) {\n      // TODO: Generate hbc for each chunk\n      const hermesBundleOutput = await buildHermesBundleAsync({\n        filename: this.name,\n        code: jsAsset.source,\n        map: assets[1] ? assets[1].source : null,\n        // TODO: Maybe allow prod + no minify.\n        minify: true, //!this.options.dev,\n      });\n\n      if (hermesBundleOutput.hbc) {\n        // TODO: Unclear if we should add multiple assets, link the assets, or mutate the first asset.\n        // jsAsset.metadata.hbc = hermesBundleOutput.hbc;\n        // @ts-expect-error: TODO\n        jsAsset.source = hermesBundleOutput.hbc;\n        jsAsset.filename = jsAsset.filename.replace(/\\.js$/, '.hbc');\n      }\n      if (assets[1] && hermesBundleOutput.sourcemap) {\n        // TODO: Unclear if we should add multiple assets, link the assets, or mutate the first asset.\n        assets[1].source = hermesBundleOutput.sourcemap;\n      }\n    }\n\n    return assets;\n  }\n\n  private supportsBytecode() {\n    return this.getPlatform() !== 'web';\n  }\n\n  isHermesEnabled() {\n    // TODO: Revisit.\n    // TODO: There could be an issue with having the serializer for export:embed output hermes since the native scripts will\n    // also create hermes bytecode. We may need to disable in one of the two places.\n    return (\n      !this.options.dev &&\n      this.supportsBytecode() &&\n      this.graph.transformOptions.customTransformOptions?.engine === 'hermes'\n    );\n  }\n}\n\nfunction getEntryModulesForChunkSettings(graph: ReadOnlyGraph, settings: ChunkSettings) {\n  return [...graph.dependencies.entries()]\n    .filter(([path]) => settings.test.test(path))\n    .map(([, module]) => module);\n}\n\nfunction chunkIdForModules(modules: Module[]) {\n  return modules\n    .map((module) => module.path)\n    .sort()\n    .join('=>');\n}\n\nfunction gatherChunks(\n  chunks: Set<Chunk>,\n  settings: ChunkSettings,\n  preModules: readonly Module[],\n  graph: ReadOnlyGraph,\n  options: SerializerOptions<MixedOutput>,\n  isAsync: boolean = false\n): Set<Chunk> {\n  let entryModules = getEntryModulesForChunkSettings(graph, settings);\n\n  const existingChunks = [...chunks.values()];\n\n  entryModules = entryModules.filter((module) => {\n    return !existingChunks.find((chunk) => chunk.entries.includes(module));\n  });\n\n  // Prevent processing the same entry file twice.\n  if (!entryModules.length) {\n    return chunks;\n  }\n\n  const entryChunk = new Chunk(\n    chunkIdForModules(entryModules),\n    entryModules,\n    graph,\n    options,\n    isAsync\n  );\n\n  // Add all the pre-modules to the first chunk.\n  if (preModules.length) {\n    // On native, use the preModules in insert code in the entry chunk.\n    for (const module of preModules.values()) {\n      entryChunk.preModules.add(module);\n    }\n  }\n\n  chunks.add(entryChunk);\n\n  function includeModule(entryModule: Module<MixedOutput>) {\n    for (const dependency of entryModule.dependencies.values()) {\n      // TODO: Create more chunks\n      const module = graph.dependencies.get(dependency.absolutePath);\n      if (module) {\n        // Prevent circular dependencies from creating infinite loops.\n        if (!entryChunk.deps.has(module)) {\n          entryChunk.deps.add(module);\n          includeModule(module);\n        }\n      }\n    }\n  }\n\n  for (const entryModule of entryModules) {\n    includeModule(entryModule);\n  }\n\n  return chunks;\n}\n\nasync function serializeChunksAsync(\n  chunks: Set<Chunk>,\n  serializerConfig: Partial<SerializerConfigT>,\n  { includeSourceMaps, includeBytecode }: SerializeChunkOptions\n) {\n  const jsAssets: SerialAsset[] = [];\n\n  await Promise.all(\n    [...chunks].map(async (chunk) => {\n      jsAssets.push(\n        ...(await chunk.serializeToAssetsAsync(serializerConfig, {\n          includeSourceMaps,\n          includeBytecode,\n        }))\n      );\n    })\n  );\n\n  return jsAssets;\n}\n\nfunction getSortedModules(\n  modules: Module<MixedOutput>[],\n  {\n    createModuleId,\n  }: {\n    createModuleId: (path: string) => number;\n  }\n): readonly Module<any>[] {\n  // Assign IDs to modules in a consistent order\n  for (const module of modules) {\n    createModuleId(module.path);\n  }\n  // Sort by IDs\n  return modules.sort(\n    (a: Module<any>, b: Module<any>) => createModuleId(a.path) - createModuleId(b.path)\n  );\n}\n"],"mappings":"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"}