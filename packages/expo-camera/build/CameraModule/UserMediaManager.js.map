{"version":3,"file":"UserMediaManager.js","sourceRoot":"","sources":["../../src/CameraModule/UserMediaManager.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-env browser */\nimport { canUseDOM } from 'fbjs/lib/ExecutionEnvironment';\n\nexport let userMediaRequested: boolean = false;\nexport let mountedInstances: any[] = [];\n\nasync function requestLegacyUserMediaAsync(props): Promise<any[]> {\n  const optionalSource = id => ({ optional: [{ sourceId: id }] });\n\n  const constraintToSourceId = constraint => {\n    const { deviceId } = constraint;\n\n    if (typeof deviceId === \"string\") {\n      return deviceId;\n    }\n\n    if (Array.isArray(deviceId) && deviceId.length > 0) {\n      return deviceId[0];\n    }\n\n    if (typeof deviceId === \"object\" && deviceId.ideal) {\n      return deviceId.ideal;\n    }\n\n    return null;\n  };\n\n  // @ts-ignore: https://caniuse.com/#search=getSources Chrome for Android (78) & Samsung Internet (10.1) use this\n  const sources: any[] = await (new Promise((resolve) => MediaStreamTrack.getSources(sources => resolve(sources))))\n\n  let audioSource = null;\n  let videoSource = null;\n\n  sources.forEach(source => {\n    if (source.kind === \"audio\") {\n      audioSource = source.id;\n    } else if (source.kind === \"video\") {\n      videoSource = source.id;\n    }\n  });\n\n  const audioSourceId = constraintToSourceId(props.audioConstraints);\n  if (audioSourceId) {\n    audioSource = audioSourceId;\n  }\n\n  const videoSourceId = constraintToSourceId(props.videoConstraints);\n  if (videoSourceId) {\n    videoSource = videoSourceId;\n  }\n\n  return [\n    optionalSource(audioSource),\n    optionalSource(videoSource)\n  ]\n}\n\nasync function sourceSelectedAsync(isMuted: boolean, audioConstraints?: MediaTrackConstraints | boolean, videoConstraints?: MediaTrackConstraints | boolean): Promise<MediaStream> {\n  const constraints: MediaStreamConstraints = {\n    video: typeof videoConstraints !== \"undefined\" ? videoConstraints : true\n  };\n\n  if (!isMuted) {\n    constraints.audio =\n      typeof audioConstraints !== \"undefined\" ? audioConstraints : true;\n  }\n\n  return await getAnyUserMediaAsync(constraints);\n};\n\nexport async function requestUserMediaAsync(props: { audio?: any; video?: any }, isMuted: boolean = true): Promise<MediaStream> {\n  if (canGetUserMedia()) {\n    return await sourceSelectedAsync(isMuted, props.audio, props.video);\n  } else {\n    const [audio, video] = await requestLegacyUserMediaAsync(props);\n    return await sourceSelectedAsync(isMuted, audio, video);\n  }\n//   userMediaRequested = true;\n}\n\nexport async function getAnyUserMediaAsync(constraints: MediaStreamConstraints, ignoreConstraints: boolean = false): Promise<MediaStream> {\n    try {\n        return await getUserMediaAsync({\n            ...constraints,\n            video: ignoreConstraints || constraints.video\n        });\n    } catch (error) {\n        if (!ignoreConstraints && error.name === 'ConstraintNotSatisfiedError') {\n            return await getAnyUserMediaAsync(constraints, true)\n        }\n        throw error;\n    }\n}\n\nexport async function getUserMediaAsync(constraints: MediaStreamConstraints): Promise<MediaStream> {\n  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {\n    return navigator.mediaDevices.getUserMedia(constraints);\n  }\n\n  const _getUserMedia = navigator['mozGetUserMedia'] || navigator['webkitGetUserMedia'] || navigator['msGetUserMedia'];\n  return new Promise((resolve, reject) =>\n    _getUserMedia.call(navigator, constraints, resolve, reject)\n  );\n}\n\nexport function canGetUserMedia(): boolean {\n  return (\n    // SSR\n    canUseDOM &&\n    // Has any form of media API\n    !!((navigator.mediaDevices && navigator.mediaDevices.getUserMedia) ||\n      navigator['mozGetUserMedia'] || \n      navigator['webkitGetUserMedia'] ||\n      navigator['msGetUserMedia'])\n  );\n}\n\nexport async function isFrontCameraAvailableAsync(devices?: MediaDeviceInfo[]): Promise<null | string> {  \n    return await supportsCameraType(['front', 'user'], 'user', devices);\n}\n\nexport async function isBackCameraAvailableAsync(devices?: MediaDeviceInfo[]): Promise<null | string> {  \n    return await supportsCameraType(['back', 'rear'], 'environment', devices);\n}\n\nasync function supportsCameraType(labels: string[], type: string, devices?: MediaDeviceInfo[]): Promise<null | string> {\n    if (!devices) {\n        if (!navigator.mediaDevices.enumerateDevices) {\n            return null;\n        }\n        devices = await navigator.mediaDevices.enumerateDevices()\n    }\n    const cameras = devices.filter(t => t.kind === 'videoinput');\n    const [hasCamera] = cameras.filter((camera) => labels.includes(camera.label.toLowerCase()));\n    const [isCapable] = cameras.filter((camera) => {\n      if (!('getCapabilities' in camera)) {\n        return null;\n      }\n  \n      const capabilities = (camera as any).getCapabilities();\n      if (!capabilities.facingMode) {\n        return null;\n      }\n  \n      return capabilities.facingMode.find((_: string) => type);\n    });\n  \n    return isCapable.deviceId || hasCamera.deviceId || null;\n  }"]}