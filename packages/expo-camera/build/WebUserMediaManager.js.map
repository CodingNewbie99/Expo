{"version":3,"file":"WebUserMediaManager.js","sourceRoot":"","sources":["../src/WebUserMediaManager.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-env browser */\r\n/**\r\n * A web-only module for ponyfilling the UserMedia API.\r\n */\r\nimport { Platform } from '@unimodules/core';\r\n\r\nexport const userMediaRequested: boolean = false;\r\n\r\nexport const mountedInstances: any[] = [];\r\n\r\nasync function requestLegacyUserMediaAsync(props): Promise<any[]> {\r\n  const optionalSource = id => ({ optional: [{ sourceId: id }] });\r\n\r\n  const constraintToSourceId = constraint => {\r\n    const { deviceId } = constraint;\r\n\r\n    if (typeof deviceId === 'string') {\r\n      return deviceId;\r\n    }\r\n\r\n    if (Array.isArray(deviceId) && deviceId.length > 0) {\r\n      return deviceId[0];\r\n    }\r\n\r\n    if (typeof deviceId === 'object' && deviceId.ideal) {\r\n      return deviceId.ideal;\r\n    }\r\n\r\n    return null;\r\n  };\r\n\r\n  const sources: any[] = await new Promise(resolve =>\r\n    // @ts-ignore: https://caniuse.com/#search=getSources Chrome for Android (78) & Samsung Internet (10.1) use this\r\n    MediaStreamTrack.getSources(sources => resolve(sources))\r\n  );\r\n\r\n  let audioSource = null;\r\n  let videoSource = null;\r\n\r\n  sources.forEach(source => {\r\n    if (source.kind === 'audio') {\r\n      audioSource = source.id;\r\n    } else if (source.kind === 'video') {\r\n      videoSource = source.id;\r\n    }\r\n  });\r\n\r\n  const audioSourceId = constraintToSourceId(props.audioConstraints);\r\n  if (audioSourceId) {\r\n    audioSource = audioSourceId;\r\n  }\r\n\r\n  const videoSourceId = constraintToSourceId(props.videoConstraints);\r\n  if (videoSourceId) {\r\n    videoSource = videoSourceId;\r\n  }\r\n\r\n  return [optionalSource(audioSource), optionalSource(videoSource)];\r\n}\r\n\r\nasync function sourceSelectedAsync(\r\n  isMuted: boolean,\r\n  audioConstraints?: MediaTrackConstraints | boolean,\r\n  videoConstraints?: MediaTrackConstraints | boolean\r\n): Promise<MediaStream> {\r\n  const constraints: MediaStreamConstraints = {\r\n    video: typeof videoConstraints !== 'undefined' ? videoConstraints : true,\r\n  };\r\n\r\n  if (!isMuted) {\r\n    constraints.audio = typeof audioConstraints !== 'undefined' ? audioConstraints : true;\r\n  }\r\n\r\n  return await getAnyUserMediaAsync(constraints);\r\n}\r\n\r\nexport async function requestUserMediaAsync(\r\n  props: { audio?: any; video?: any },\r\n  isMuted: boolean = true\r\n): Promise<MediaStream> {\r\n  if (canGetUserMedia()) {\r\n    return await sourceSelectedAsync(isMuted, props.audio, props.video);\r\n  }\r\n  const [audio, video] = await requestLegacyUserMediaAsync(props);\r\n  return await sourceSelectedAsync(isMuted, audio, video);\r\n}\r\n\r\nexport async function getAnyUserMediaAsync(\r\n  constraints: MediaStreamConstraints,\r\n  ignoreConstraints: boolean = false\r\n): Promise<MediaStream> {\r\n  try {\r\n    return await getUserMediaAsync({\r\n      ...constraints,\r\n      video: ignoreConstraints || constraints.video,\r\n    });\r\n  } catch (error) {\r\n    if (!ignoreConstraints && error.name === 'ConstraintNotSatisfiedError') {\r\n      return await getAnyUserMediaAsync(constraints, true);\r\n    }\r\n    throw error;\r\n  }\r\n}\r\n\r\nexport async function getUserMediaAsync(constraints: MediaStreamConstraints): Promise<MediaStream> {\r\n  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {\r\n    return navigator.mediaDevices.getUserMedia(constraints);\r\n  }\r\n\r\n  const _getUserMedia =\r\n    navigator['mozGetUserMedia'] || navigator['webkitGetUserMedia'] || navigator['msGetUserMedia'];\r\n  return new Promise((resolve, reject) =>\r\n    _getUserMedia.call(navigator, constraints, resolve, reject)\r\n  );\r\n}\r\n\r\nexport function canGetUserMedia(): boolean {\r\n  return (\r\n    // SSR\r\n    Platform.isDOMAvailable &&\r\n    // Has any form of media API\r\n    !!(\r\n      (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) ||\r\n      navigator['mozGetUserMedia'] ||\r\n      navigator['webkitGetUserMedia'] ||\r\n      navigator['msGetUserMedia']\r\n    )\r\n  );\r\n}\r\n\r\nexport async function isFrontCameraAvailableAsync(\r\n  devices?: MediaDeviceInfo[]\r\n): Promise<null | string> {\r\n  return await supportsCameraType(['front', 'user', 'facetime'], 'user', devices);\r\n}\r\n\r\nexport async function isBackCameraAvailableAsync(\r\n  devices?: MediaDeviceInfo[]\r\n): Promise<null | string> {\r\n  return await supportsCameraType(['back', 'rear'], 'environment', devices);\r\n}\r\n\r\nasync function supportsCameraType(\r\n  labels: string[],\r\n  type: string,\r\n  devices?: MediaDeviceInfo[]\r\n): Promise<null | string> {\r\n  if (!devices) {\r\n    if (!navigator.mediaDevices.enumerateDevices) {\r\n      return null;\r\n    }\r\n    devices = await navigator.mediaDevices.enumerateDevices();\r\n  }\r\n  const cameras = devices.filter(t => t.kind === 'videoinput');\r\n  const [hasCamera] = cameras.filter(camera =>\r\n    labels.some(label => camera.label.toLowerCase().includes(label))\r\n  );\r\n  const [isCapable] = cameras.filter(camera => {\r\n    if (!('getCapabilities' in camera)) {\r\n      return null;\r\n    }\r\n\r\n    const capabilities = (camera as any).getCapabilities();\r\n    if (!capabilities.facingMode) {\r\n      return null;\r\n    }\r\n\r\n    return capabilities.facingMode.find((_: string) => type);\r\n  });\r\n\r\n  return isCapable?.deviceId || hasCamera?.deviceId || null;\r\n}\r\n"]}