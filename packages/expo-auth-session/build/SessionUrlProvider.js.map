{"version":3,"file":"SessionUrlProvider.js","sourceRoot":"","sources":["../src/SessionUrlProvider.ts"],"names":[],"mappings":"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","sourcesContent":["import Constants from 'expo-constants';\nimport qs from 'qs';\n\nconst { manifest } = Constants;\n\nlet _getDefaultReturnUrl: () => string;\nlet _getStartUrl: (authUrl: string, returnUrl: string) => string;\nlet _getRedirectUrl: () => string;\n\nif (manifest) {\n  const BASE_URL = `https://auth.expo.io`;\n  const SESSION_PATH = 'expo-auth-session';\n  const USES_CUSTOM_SCHEME = Constants.appOwnership === 'standalone' && manifest.scheme;\n  let HOST_URI = manifest.hostUri;\n  if (!HOST_URI && !USES_CUSTOM_SCHEME) {\n    // we're probably not using up-to-date xdl, so just fake it for now\n    // we have to remove the /--/ on the end since this will be inserted again later\n    HOST_URI = _removeScheme(Constants.linkingUri).replace(/\\/--($|\\/.*$)/, '');\n  }\n\n  const IS_EXPO_HOSTED =\n    HOST_URI &&\n    (/^(.*\\.)?(expo\\.io|exp\\.host|exp\\.direct|expo\\.test)(:.*)?(\\/.*)?$/.test(HOST_URI) ||\n      manifest.developer);\n\n  _getDefaultReturnUrl = (): string => {\n    let scheme = 'exp';\n    let path = SESSION_PATH;\n    let manifestScheme = manifest.scheme || (manifest.detach && manifest.detach.scheme);\n\n    if (Constants.appOwnership === 'standalone' && manifestScheme) {\n      scheme = manifestScheme;\n    } else if (Constants.appOwnership === 'standalone' && !manifestScheme) {\n      throw new Error(\n        'Cannot make a deep link into a standalone app with no custom scheme defined'\n      );\n    } else if (Constants.appOwnership === 'expo' && !manifestScheme) {\n      console.warn(\n        'Linking requires that you provide a `scheme` in app.json for standalone apps - if it is left blank, your app may crash. The scheme does not apply to development in the Expo client but you should add it as soon as you start working with Linking to avoid creating a broken build. Add a `scheme` to silence this warning. Learn more about Linking at https://docs.expo.io/versions/latest/workflow/linking/'\n      );\n    }\n\n    let hostUri = HOST_URI || '';\n    if (USES_CUSTOM_SCHEME && IS_EXPO_HOSTED) {\n      hostUri = '';\n    }\n\n    if (path) {\n      if (IS_EXPO_HOSTED && hostUri) {\n        path = `/--/${_removeLeadingSlash(path)}`;\n      }\n\n      if (!path.startsWith('/')) {\n        path = `/${path}`;\n      }\n    } else {\n      path = '';\n    }\n\n    hostUri = _removeTrailingSlash(hostUri);\n\n    return encodeURI(`${scheme}://${hostUri}${path}`);\n  };\n\n  _getRedirectUrl = (): string => {\n    const redirectUrl = `${BASE_URL}/${Constants.manifest.id}`;\n    if (__DEV__) {\n      _warnIfAnonymous(Constants.manifest.id, redirectUrl);\n    }\n    return redirectUrl;\n  };\n\n  _getStartUrl = (authUrl: string, returnUrl: string): string => {\n    let queryString = qs.stringify({\n      authUrl,\n      returnUrl,\n    });\n\n    return `${_getRedirectUrl()}/start?${queryString}`;\n  };\n} else {\n  _getDefaultReturnUrl = (): string => {\n    throw new Error('You are using bare flow which does not support `default return url`.');\n  };\n\n  _getStartUrl = (authUrl: string): string => {\n    return authUrl;\n  };\n\n  _getRedirectUrl = () => {\n    throw new Error('You need to specify the redirect url.');\n  };\n}\n\nexport const getDefaultReturnUrl = _getDefaultReturnUrl;\nexport const getStartUrl = _getStartUrl;\nexport const getRedirectUrl = _getRedirectUrl;\n\nfunction _removeScheme(url: string) {\n  return url.replace(/^[a-zA-Z0-9+.-]+:\\/\\//, '');\n}\n\nfunction _removeLeadingSlash(url: string) {\n  return url.replace(/^\\//, '');\n}\n\nfunction _removeTrailingSlash(url: string) {\n  return url.replace(/\\/$/, '');\n}\n\nfunction _warnIfAnonymous(id, url): void {\n  if (id.startsWith('@anonymous/')) {\n    console.warn(\n      `You are not currently signed in to Expo on your development machine. As a result, the redirect URL for AuthSession will be \"${url}\". If you are using an OAuth provider that requires whitelisting redirect URLs, we recommend that you do not whitelist this URL -- instead, you should sign in to Expo to acquired a unique redirect URL. Additionally, if you do decide to publish this app using Expo, you will need to register an account to do it.`\n    );\n  }\n}\n"]}